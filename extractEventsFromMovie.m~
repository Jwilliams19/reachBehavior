function [out,zoneVals,reaches,pellets,eat,paw,fidget,settings]=extractEventsFromMovie(zonesFile, movieFile, zoneVals)

settings=autoReachAnalysisSettings(); % get current settings for this analysis
settings.zonesFile=zonesFile;
settings.movieFile=movieFile;

% Read intensity in user-defined zones over course of movie
if isempty(zoneVals)
    zoneVals=readIntensityValues(zonesFile, movieFile);
    readZoneVals=1;
else
    readZoneVals=0;
end

% Save zone data
if settings.saveZoneData==1 && readZoneVals==1
    endoffname=regexp(movieFile,'\.');
    save([movieFile(1:endoffname(end)-1) '_zoneVals.mat'],'zoneVals');
end

% Save analysis settings
if settings.saveZoneData==1
    endoffname=regexp(movieFile,'\.');
    save([movieFile(1:endoffname(end)-1) '_settings.mat'],'settings');
end

% Discard first n frames
f=fieldnames(zoneVals);
for i=1:length(f)
    temp=zoneVals.(f{i});
    zoneVals.(f{i})=temp(settings.discardFirstNFrames+1:end);
end

% Get reach data
reaches=getReaches(zoneVals.reachZone);

% Get pellet data
pellets=getPelletInPlace(zoneVals.pelletZone);

% Get chewing data
eat=getChewing(zoneVals.eatZone);

% Get paw at mouth data
paw=getPawAtMouth(zoneVals.eatZone);

% Get fidgeting in perch zone data
fidget=getFidget(zoneVals.perchZone);

[~,out]=codeEvents(reaches,pellets,eat,paw,fidget);

% Make frame numbers here match movie's frame numbers
% by adding back discardFirstNFrames
nreaches=length(out.reachTypes);
exceptFields={'reachTypes'};
%out=addNFramestoData(out, nreaches, settings.discardFirstNFrames, exceptFields);
%reaches=addNFramestoData(reaches, nreaches, settings.discardFirstNFrames, {});

% Save output
if settings.saveZoneData==1
    endoffname=regexp(movieFile,'\.');
    save([movieFile(1:endoffname(end)-1) '_events.mat'],'out');
    save([movieFile(1:endoffname(end)-1) '_reaches.mat'],'reaches');
    save([movieFile(1:endoffname(end)-1) '_pellets.mat'],'pellets');
    save([movieFile(1:endoffname(end)-1) '_eat.mat'],'eat');
    save([movieFile(1:endoffname(end)-1) '_paw.mat'],'paw');
    save([movieFile(1:endoffname(end)-1) '_fidget.mat'],'fidget');
end

end

function data=addNFramestoData(data, n, addFrames, exceptFields)

f=fieldnames(data);
for i=1:length(f)
    if length(data.(f{i}))==n && nanmax(data.(f{i}))>1 && ~ismember(f{i},exceptFields)
        data.(f{i})=data.(f{i})+addFrames;
    end
end

end